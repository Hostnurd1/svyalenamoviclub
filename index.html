<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–°–≤—è—Ç & –ê–ª—ë–Ω–∞ MovieClub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f7f8fa; margin: 0; color: #232323; }
    .container { max-width: 480px; margin: 40px auto; background: #fff; border-radius: 24px; box-shadow: 0 6px 32px #0001; padding: 28px 22px; }
    .add-movie { display: flex; gap: 6px; margin: 18px 0 20px 0; }
    input[type="text"] { padding: 7px; border-radius: 10px; border: 1px solid #dbeafe; width: 62%; }
    button { padding: 8px 16px; border-radius: 10px; border: none; background: #5e81f4; color: #fff; font-weight: 500; cursor: pointer; }
    .movie-list { list-style: none; padding: 0; }
    .movie { background: #f2f7fe; margin-bottom: 16px; border-radius: 14px; padding: 13px 15px; }
    .movie-title { font-size: 19px; font-weight: 600; margin-bottom: 5px; }
    .mini { font-size: 13px; color: #555; }
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    #user-modal {position:fixed; left:0; top:0; width:100vw; height:100vh; background:#fffdfedc; z-index:99; display:none; align-items:center; justify-content:center; flex-direction:column;}
  </style>
</head>
<body>
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
  <div id="user-modal">
    <div style="background:#fff; border-radius:18px; box-shadow:0 6px 32px #0002; padding:32px 28px; text-align:center; min-width:220px;">
      <div style="font-size:22px; font-weight:700; margin-bottom:18px;">–ö—Ç–æ –≤—ã?</div>
      <button id="modal-btn-svyat" style="margin:10px 0 5px 0; padding:10px 40px; border-radius:12px; font-size:19px; background:#5e81f4; color:#fff; border:none; cursor:pointer;" onclick="chooseUser('–°–≤—è—Ç',true)">–Ø ‚Äî –°–≤—è—Ç</button><br>
      <button id="modal-btn-alena" style="margin:5px 0 5px 0; padding:10px 40px; border-radius:12px; font-size:19px; background:#5e81f4; color:#fff; border:none; cursor:pointer;" onclick="chooseUser('–ê–ª—ë–Ω–∞',true)">–Ø ‚Äî –ê–ª—ë–Ω–∞</button>
    </div>
  </div>
  <!-- –ü–∞–Ω–µ–ª—å —Ä—É—á–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –ø–æ–¥—Å–≤–µ—Ç–∫–∞) -->
  <div style="margin: 32px auto 10px auto; text-align: center;">
    <button id="btn-svyat" onclick="chooseUser('–°–≤—è—Ç')" style="margin-right:15px;">–Ø ‚Äî –°–≤—è—Ç</button>
    <button id="btn-alena" onclick="chooseUser('–ê–ª—ë–Ω–∞')">–Ø ‚Äî –ê–ª—ë–Ω–∞</button>
  </div>
  <div class="container">
    <h1>–°–≤—è—Ç & –ê–ª—ë–Ω–∞ MovieClub</h1>
    <div class="add-movie">
      <input type="text" id="new-movie-title" placeholder="–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º...">
      <button onclick="addMovie()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <ul class="movie-list" id="movie-list"></ul>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
  <script>
       // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAxLMSDQSPon7NTd9loVRMLNCseBFSOTDc",
      authDomain: "movieclub-aba80.firebaseapp.com",
      projectId: "movieclub-aba80",
      storageBucket: "movieclub-aba80.appspot.com",
      messagingSenderId: "747897349535",
      appId: "1:747897349535:web:bd29be3880dbcffac749aa",
      measurementId: "G-LQ40KH85NE"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ---
    let currentUser = localStorage.getItem('mc_user') || '';

    // –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: –ø–æ–¥—Å–≤–µ—Ç–∫–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Å–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    function chooseUser(user, fromModal = false) {
      currentUser = user;
      localStorage.setItem('mc_user', user);
      // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
      const btnS = document.getElementById('btn-svyat');
      const btnA = document.getElementById('btn-alena');
      if(btnS && btnA) {
        btnS.style.background = (user === '–°–≤—è—Ç') ? '#5e81f4' : '';
        btnS.style.color = (user === '–°–≤—è—Ç') ? '#fff' : '';
        btnA.style.background = (user === '–ê–ª—ë–Ω–∞') ? '#5e81f4' : '';
        btnA.style.color = (user === '–ê–ª—ë–Ω–∞') ? '#fff' : '';
      }
      // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –≤—ã–∑–æ–≤ –±—ã–ª –∏–∑ –Ω–µ–≥–æ
      if(fromModal) {
        document.getElementById('user-modal').style.display = 'none';
      }
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª–∫—É, –∏–Ω–∞—á–µ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –≤—ã–±–æ—Ä
    window.onload = function() {
      if (!currentUser) {
        document.getElementById('user-modal').style.display = 'flex';
      } else {
        chooseUser(currentUser);
      }
    }
    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –§–ò–õ–¨–ú–ê ---
    async function addMovie() {
      const title = document.getElementById('new-movie-title').value.trim();
      if (!title || !currentUser) return;
      await db.collection('movies').add({
        title: title,
        status: '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω',
        date: new Date().toISOString(),
        addedBy: currentUser
      });
      document.getElementById('new-movie-title').value = '';
      loadMovies();
    }

    // --- –ó–ê–ì–†–£–ó–ö–ê/–û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –§–ò–õ–¨–ú–û–í ---
    async function loadMovies() {
      const res = await db.collection('movies').orderBy('date', 'desc').get();
      let html = '';
      res.forEach(doc => {
        const m = doc.data();
        html += `<li class="movie">
          <div class="movie-title">${m.title}</div>
          <div class="mini">${m.status || ''}</div>
          <div class="mini">–î–æ–±–∞–≤–∏–ª: ${m.addedBy || '-'}</div>
        </li>`;
      });
      document.getElementById('movie-list').innerHTML = html;
    }

    // --- –ê–í–¢–û–ó–ê–ì–†–£–ó–ö–ê –ü–†–ò –°–¢–ê–†–¢–ï ---
    loadMovies();
    // --- –î–û–ë–ê–í–õ–Ø–ï–ú –ü–û–õ–Ø –î–õ–Ø –û–¶–ï–ù–û–ö, –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í, –≠–ú–û–î–ó–ò ---
    async function setScore(id, user, value) {
      const field = user === '–°–≤—è—Ç' ? 'scoreSvyat' : 'scoreAlena';
      await db.collection('movies').doc(id).update({ [field]: Number(value) });
      loadMovies();
    }
    async function setComment(id, user, value) {
      const field = user === '–°–≤—è—Ç' ? 'commentSvyat' : 'commentAlena';
      await db.collection('movies').doc(id).update({ [field]: value });
      loadMovies();
    }
    async function setEmoji(id, user, value) {
      const field = user === '–°–≤—è—Ç' ? 'emojiSvyat' : 'emojiAlena';
      await db.collection('movies').doc(id).update({ [field]: value });
      loadMovies();
    }

    // –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è loadMovies —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ —Ä–µ–Ω–¥–µ—Ä–æ–º:
    async function loadMovies() {
      const res = await db.collection('movies').orderBy('date', 'desc').get();
      let html = '';
      res.forEach(doc => {
        const m = doc.data();
        html += `<li class="movie">
          <div class="movie-title">${m.title} <span class="mini">(${m.status || ''})</span></div>
          <div class="mini">–î–æ–±–∞–≤–∏–ª: ${m.addedBy || '-'}</div>
          <div>
            <b>–°–≤—è—Ç:</b>
            <input type="number" min="1" max="10" value="${m.scoreSvyat ?? ''}"
              onchange="setScore('${doc.id}','–°–≤—è—Ç',this.value)" ${currentUser!=='–°–≤—è—Ç'?'disabled':''} style="width:34px">
            <input type="text" maxlength="2" placeholder="üòä" value="${m.emojiSvyat || ''}"
              onchange="setEmoji('${doc.id}','–°–≤—è—Ç',this.value)" ${currentUser!=='–°–≤—è—Ç'?'disabled':''} style="width:34px">
            <input type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${m.commentSvyat || ''}"
              onchange="setComment('${doc.id}','–°–≤—è—Ç',this.value)" ${currentUser!=='–°–≤—è—Ç'?'disabled':''} style="width:90px">
          </div>
          <div>
            <b>–ê–ª—ë–Ω–∞:</b>
            <input type="number" min="1" max="10" value="${m.scoreAlena ?? ''}"
              onchange="setScore('${doc.id}','–ê–ª—ë–Ω–∞',this.value)" ${currentUser!=='–ê–ª—ë–Ω–∞'?'disabled':''} style="width:34px">
            <input type="text" maxlength="2" placeholder="üòç" value="${m.emojiAlena || ''}"
              onchange="setEmoji('${doc.id}','–ê–ª—ë–Ω–∞',this.value)" ${currentUser!=='–ê–ª—ë–Ω–∞'?'disabled':''} style="width:34px">
            <input type="text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" value="${m.commentAlena || ''}"
              onchange="setComment('${doc.id}','–ê–ª—ë–Ω–∞',this.value)" ${currentUser!=='–ê–ª—ë–Ω–∞'?'disabled':''} style="width:90px">
          </div>
          <b>–°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: ${
            (m.scoreSvyat && m.scoreAlena)
              ? ((Number(m.scoreSvyat)+Number(m.scoreAlena))/2).toFixed(1)
              : '-'
          }</b>
        </li>`;
      });
      document.getElementById('movie-list').innerHTML = html;
    }
    // --- –†–ê–ù–î–û–ú–ê–ô–ó–ï–† "–ß–¢–û –°–ú–û–¢–†–ï–¢–¨?" ---

    // –î–æ–±–∞–≤—å –∫–Ω–æ–ø–∫—É –∏ –±–ª–æ–∫ –≤—ã–≤–æ–¥–∞ –≤ HTML (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–¥ —Å–ø–∏—Å–∫–æ–º —Ñ–∏–ª—å–º–æ–≤):
    // <button onclick="randomMovie()" style="margin: 16px 0; width: 100%;">üé≤ –ß—Ç–æ —Å–º–æ—Ç—Ä–µ—Ç—å?</button>
    // <div id="random-out"></div>

    async function randomMovie() {
      const res = await db.collection('movies').where('status','==','–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω').get();
      const arr = [];
      res.forEach(doc => arr.push(doc.data()));
      if (arr.length === 0) {
        document.getElementById('random-out').innerText = '–ù–µ—Ç —Ñ–∏–ª—å–º–æ–≤ –≤ –ø–ª–∞–Ω–∞—Ö!';
        return;
      }
      const rnd = arr[Math.floor(Math.random()*arr.length)];
      document.getElementById('random-out').innerHTML = `üé¨ –í–∞—à –≤—ã–±–æ—Ä: <b>${rnd.title}</b>`;
    }

    // --- –§–ò–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö ---

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (!currentUser) {
      document.getElementById('user-modal').style.display = 'flex';
    } else {
      chooseUser(currentUser);
    }
  </script>
</body>
</html>
